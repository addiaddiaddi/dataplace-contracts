// SPDX-License-Identifier: UNLICENSED
pragma solidity ^0.8.13;

import {Test, console2} from "forge-std/Test.sol";
import {Marketplace} from "../src/Marketplace.sol";
import "../src/USDC.sol";
import "forge-std/console.sol";
contract RsaTest is Test {
    Marketplace marketplace; 
    uint256 public publicKey;
    uint256 public privateKey;
    uint256 public n;

    uint256 public terraPrivateKey = uint256(0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80);
    address public terraAddress = 0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266;
    address public seller = address(uint160(150));

    USDC public usdc;
    function setUp() public {
        usdc = new USDC();
        marketplace = new Marketplace(address(usdc), terraAddress);
        (publicKey, privateKey,n) = marketplace.getKeys();
        // publicKey = 3740835993;
        // privateKey = 1423449577;
        // n = 3928803607;
    }


    /// forge-config: default.fuzz.runs = 1000
    function testFuzz_rsa(uint256 message_) public {

        uint256 message = bound(message_,1, type(uint8).max);
        console.log("message", message);
        uint256 encrypted = marketplace.encrypt(message, publicKey, n);

        assertEq(marketplace.decrypt(encrypted, privateKey, n), message);
    }

    function test_recursiveExponent() external {
        require(marketplace.recursiveExponent(13, 88, 19) == 9, "marketplace.recursiveExponent(13, 88, 19) == 19");
        require(marketplace.recursiveExponent(13, 33, 59) == 54, "marketplace.recursiveExponent(13, 88, 19) == 19");
        require(marketplace.recursiveExponent(5885, 5835, 583) == 352, "marketplace.recursiveExponent(13, 88, 19) == 19");
    }

    function test_encryptDecryptBytes() external { 
        bytes memory data = abi.encodePacked(hex"7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d");
        // bytes memory data = abi.encodePacked(hex"7b2261223a20337d");
        // console.log("json data: ");
        // console.logBytes(data);
        // console.log(string(data));
        // console.log(data.length);

        // for (uint i; i < data.length; i++) {
        //     // console.logBytes1(data[i]);
        //     uint256 enc = marketplace.encrypt(uint8(data[i]), publicKey, n);
        //     uint256 unenc = marketplace.decrypt(enc, privateKey, n);
        //     console.log("value", i, uint8(data[i]), enc);
        // }

        uint256[] memory encryptedData = marketplace.encryptBytes(data, publicKey, n);

        assertEq(marketplace.decryptArray(encryptedData, privateKey, n), data);
    }

    function test_validateTerraSig() external {


        bytes memory data = abi.encodePacked(hex"7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d");
        
        (uint8 v, bytes32 r, bytes32 s) = vm.sign(terraPrivateKey, keccak256(data));

        require(marketplace.isTerraSignature(data, v, r, s) == true);

        (v, r, s) = vm.sign(terraPrivateKey - 1, keccak256(data));

        require(marketplace.isTerraSignature(data, v, r, s) == false);

    }

    function _createOrder() internal {
        usdc.mint(address(this), 100*10**18);
        usdc.approve(address(marketplace), 100*10**18);
        marketplace.createOrder("heartbeat", 100*10**18, publicKey, n);
    }

    function test_orderHappy() external {
        _createOrder();

        bytes memory data = abi.encodePacked(hex"7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d");
        
        (uint8 v, bytes32 r, bytes32 s) = vm.sign(terraPrivateKey, keccak256(data));

        vm.startPrank(seller);
            marketplace.fulfillOrder(0, v, r, s, keccak256(data), marketplace.encryptBytes(data, publicKey, n));
        vm.stopPrank();

        vm.expectRevert("hashes are equal. invalid dispute");
            marketplace.disputeOrder(0,83,23);

        vm.warp(block.timestamp + marketplace.disputePeriod() + 1);

        vm.prank(seller);
            marketplace.completeOrder(0);
        
        require(usdc.balanceOf(address(seller)) == 100*10**18, "usdc balance not 100");


        assertEq(marketplace.getUnencryptedPurchase(0, privateKey), data);
    }

    function test_orderHappyProd() external {
        _createOrder();

        bytes memory data = abi.encodePacked(hex"5b7b22696e74657276616c223a205b22323032332d30382d32325430303a30303a30302e3030303030302b30313a3030222c2022323032332d30382d32335430303a30303a30302e3030303030302b30313a3030225d2c202261637469766974795f7365636f6e6473223a2032333834342c2022696e61637469766974795f7365636f6e6473223a2036323235362c20227669676f726f75735f696e74656e736974795f7365636f6e6473223a2036302c2022424d525f63616c6f72696573223a20313439352c20226e65745f61637469766974795f63616c6f72696573223a203731362c2022746f74616c5f6275726e65645f63616c6f72696573223a20323231312c202264697374616e63655f6d6574657273223a2031343037352c20227374657073223a2031393931342c20226176675f68725f62706d223a2038382e383134383134383134382c20226d61785f68725f62706d223a203132302c20226d696e5f68725f62706d223a2036322c202272657374696e675f68725f62706d223a2035372c20226176675f73617475726174696f6e5f70657263656e74616765223a2039362e383834363135333834362c202261637469766974795f7374726573735f6475726174696f6e5f7365636f6e6473223a2032343036302c20226176675f7374726573735f6c6576656c223a2036362c2022686967685f7374726573735f6475726174696f6e5f7365636f6e6473223a20393432302c20226c6f775f7374726573735f6475726174696f6e5f7365636f6e6473223a20363636302c20226d61785f7374726573735f6c6576656c223a2039362c20226d656469756d5f7374726573735f6475726174696f6e5f7365636f6e6473223a2031353138302c2022726573745f7374726573735f6475726174696f6e5f7365636f6e6473223a2036302c20227374726573735f6475726174696f6e5f7365636f6e6473223a2033313236307d2c207b22696e74657276616c223a205b22323032332d30382d32335430303a30303a30302e3030303030302b30313a3030222c2022323032332d30382d32345430303a30303a30302e3030303030302b30313a3030225d2c202261637469766974795f7365636f6e6473223a2032343636332c2022696e61637469766974795f7365636f6e6473223a2036313733372c20227669676f726f75735f696e74656e736974795f7365636f6e6473223a203234302c2022424d525f63616c6f72696573223a20313439352c20226e65745f61637469766974795f63616c6f72696573223a20313133342c2022746f74616c5f6275726e65645f63616c6f72696573223a20323632392c202264697374616e63655f6d6574657273223a2031343631372c20227374657073223a2032303730392c20226176675f68725f62706d223a2038342e323637373931363336312c20226d61785f68725f62706d223a203134322c20226d696e5f68725f62706d223a2035312c202272657374696e675f68725f62706d223a2035342c20226176675f73617475726174696f6e5f70657263656e74616765223a2039322e332c202261637469766974795f7374726573735f6475726174696f6e5f7365636f6e6473223a2033333636302c20226176675f7374726573735f6c6576656c223a2033372c2022686967685f7374726573735f6475726174696f6e5f7365636f6e6473223a2031323132302c20226c6f775f7374726573735f6475726174696f6e5f7365636f6e6473223a20313134302c20226d61785f7374726573735f6c6576656c223a2039372c20226d656469756d5f7374726573735f6475726174696f6e5f7365636f6e6473223a20363438302c2022726573745f7374726573735f6475726174696f6e5f7365636f6e6473223a2032383230302c20227374726573735f6475726174696f6e5f7365636f6e6473223a2031393734307d2c207b22696e74657276616c223a205b22323032332d30382d32345430303a30303a30302e3030303030302b30313a3030222c2022323032332d30382d32355430303a30303a30302e3030303030302b30313a3030225d2c202261637469766974795f7365636f6e6473223a2031343230332c2022696e61637469766974795f7365636f6e6473223a2037323139372c20227669676f726f75735f696e74656e736974795f7365636f6e6473223a20313032302c2022424d525f63616c6f72696573223a20313439352c20226e65745f61637469766974795f63616c6f72696573223a203738302c2022746f74616c5f6275726e65645f63616c6f72696573223a20323237352c202264697374616e63655f6d6574657273223a2031343134332c20227374657073223a2031383639362c20226176675f68725f62706d223a2039312e313832303434383837382c20226d61785f68725f62706d223a203137382c20226d696e5f68725f62706d223a2035392c202272657374696e675f68725f62706d223a2035382c20226176675f73617475726174696f6e5f70657263656e74616765223a2039322e373837352c202261637469766974795f7374726573735f6475726174696f6e5f7365636f6e6473223a2031353432302c20226176675f7374726573735f6c6576656c223a2036362c2022686967685f7374726573735f6475726174696f6e5f7365636f6e6473223a2031313136302c20226c6f775f7374726573735f6475726174696f6e5f7365636f6e6473223a20363936302c20226d61785f7374726573735f6c6576656c223a2039372c20226d656469756d5f7374726573735f6475726174696f6e5f7365636f6e6473223a20383730302c2022726573745f7374726573735f6475726174696f6e5f7365636f6e6473223a203330302c20227374726573735f6475726174696f6e5f7365636f6e6473223a2032363832307d2c207b22696e74657276616c223a205b22323032332d30382d32355430303a30303a30302e3030303030302b30313a3030222c2022323032332d30382d32365430303a30303a30302e3030303030302b30313a3030225d2c202261637469766974795f7365636f6e6473223a2032313433392c2022696e61637469766974795f7365636f6e6473223a2036343936312c20227669676f726f75735f696e74656e736974795f7365636f6e6473223a20313134302c2022424d525f63616c6f72696573223a20313236302c20226e65745f61637469766974795f63616c6f72696573223a203932382c2022746f74616c5f6275726e65645f63616c6f72696573223a20323432332c202264697374616e63655f6d6574657273223a2031373137362c20227374657073223a2032323633372c20226176675f68725f62706d223a2037382e353738393833393934342c20226d61785f68725f62706d223a203136322c20226d696e5f68725f62706d223a2034392c202272657374696e675f68725f62706d223a2035312c20226176675f73617475726174696f6e5f70657263656e74616765223a2039322e393635333337393534392c202261637469766974795f7374726573735f6475726174696f6e5f7365636f6e6473223a2032313036302c20226176675f7374726573735f6c6576656c223a2033382c2022686967685f7374726573735f6475726174696f6e5f7365636f6e6473223a20393630302c20226c6f775f7374726573735f6475726174696f6e5f7365636f6e6473223a20363738302c20226d61785f7374726573735f6c6576656c223a2039392c20226d656469756d5f7374726573735f6475726174696f6e5f7365636f6e6473223a2031313130302c2022726573745f7374726573735f6475726174696f6e5f7365636f6e6473223a2032383032302c20227374726573735f6475726174696f6e5f7365636f6e6473223a2032373438307d2c207b22696e74657276616c223a205b22323032332d30382d32365430303a30303a30302e3030303030302b30333a3030222c2022323032332d30382d32375430303a30303a30302e3030303030302b30333a3030225d2c202261637469766974795f7365636f6e6473223a203336302c2022696e61637469766974795f7365636f6e6473223a2031353234302c20227669676f726f75735f696e74656e736974795f7365636f6e6473223a2036302c2022424d525f63616c6f72696573223a203236392c20226e65745f61637469766974795f63616c6f72696573223a203234302c2022746f74616c5f6275726e65645f63616c6f72696573223a203236392c202264697374616e63655f6d6574657273223a20382c20227374657073223a2031322c20226176675f68725f62706d223a2036332e32352c20226d61785f68725f62706d223a2039372c20226d696e5f68725f62706d223a2035352c202272657374696e675f68725f62706d223a2035372c20226176675f73617475726174696f6e5f70657263656e74616765223a2039332e313433373030373837342c202261637469766974795f7374726573735f6475726174696f6e5f7365636f6e6473223a203432302c20226176675f7374726573735f6c6576656c223a2031392c2022686967685f7374726573735f6475726174696f6e5f7365636f6e6473223a2036302c20226c6f775f7374726573735f6475726174696f6e5f7365636f6e6473223a20323436302c20226d61785f7374726573735f6c6576656c223a2037382c20226d656469756d5f7374726573735f6475726174696f6e5f7365636f6e6473223a203534302c2022726573745f7374726573735f6475726174696f6e5f7365636f6e6473223a2031303230302c20227374726573735f6475726174696f6e5f7365636f6e6473223a20333036307d2c207b22696e74657276616c223a205b22323032332d30382d32375430303a30303a30302e3030303030302b30333a3030222c2022323032332d30382d32385430303a30303a30302e3030303030302b30333a3030225d2c202261637469766974795f7365636f6e6473223a2031313839392c2022696e61637469766974795f7365636f6e6473223a2037343530312c20227669676f726f75735f696e74656e736974795f7365636f6e6473223a20313038302c2022424d525f63616c6f72696573223a203834302c20226e65745f61637469766974795f63616c6f72696573223a20313439352c2022746f74616c5f6275726e65645f63616c6f72696573223a203434382c202264697374616e63655f6d6574657273223a20313934332c20227374657073223a20373431332c20226176675f68725f62706d223a2037322e323132363538323237382c20226d61785f68725f62706d223a203137392c20226d696e5f68725f62706d223a2034372c202272657374696e675f68725f62706d223a2034382c20226176675f73617475726174696f6e5f70657263656e74616765223a2039342e322c202261637469766974795f7374726573735f6475726174696f6e5f7365636f6e6473223a2031303638302c20226176675f7374726573735f6c6576656c223a2031303638302c2022686967685f7374726573735f6475726174696f6e5f7365636f6e6473223a2033322c20226c6f775f7374726573735f6475726174696f6e5f7365636f6e6473223a20373632302c20226d61785f7374726573735f6c6576656c223a2039362c20226d656469756d5f7374726573735f6475726174696f6e5f7365636f6e6473223a2031333236302c2022726573745f7374726573735f6475726174696f6e5f7365636f6e6473223a2032373630302c20227374726573735f6475726174696f6e5f7365636f6e6473223a2032363238307d5d");
        
        (uint8 v, bytes32 r, bytes32 s) = vm.sign(terraPrivateKey, keccak256(data));

        console.log("data hash, v, r,s");
        console.logBytes32(keccak256(data));
        console.log(v);
        console.logBytes32(r);
        console.logBytes32(s);

        vm.startPrank(seller);
            marketplace.fulfillOrder(0, v, r, s, keccak256(data), marketplace.encryptBytes(data, publicKey, n));
        vm.stopPrank();

        vm.expectRevert("hashes are equal. invalid dispute");
            marketplace.disputeOrder(0,83,23);

        vm.warp(block.timestamp + marketplace.disputePeriod() + 1);

        vm.prank(seller);
            marketplace.completeOrder(0);
        
        require(usdc.balanceOf(address(seller)) == 100*10**18, "usdc balance not 100");


        assertEq(marketplace.getUnencryptedPurchase(0, privateKey), data);

    }
    function test_orderSadInvalidSig() external {
        _createOrder();

        bytes memory data = abi.encodePacked(hex"7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d");

        (uint8 v, bytes32 r, bytes32 s) = vm.sign(terraPrivateKey - 1, keccak256(data));

        uint256[] memory inp = marketplace.encryptBytes(data, publicKey, n);
        vm.startPrank(seller);
        vm.expectRevert("signature must be from terra address");
            marketplace.fulfillOrder(0, v, r, s, keccak256(data), inp );
    }

    function test_orderSadValidSig() external {
        _createOrder();

        bytes memory data = abi.encodePacked(hex"7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d");

        (uint8 v, bytes32 r, bytes32 s) = vm.sign(terraPrivateKey, keccak256(data));


        bytes memory inputData = abi.encodePacked(hex"6b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d");

        uint256[] memory inp = marketplace.encryptBytes(inputData, publicKey, n);
        vm.startPrank(seller);
            marketplace.fulfillOrder(0, v, r, s, keccak256(data), inp );

        
        marketplace.disputeOrder(0,83,23);

        require(usdc.balanceOf(address(this)) == 100*10**18);
    }

    function test_orderHappyBig() external {
        _createOrder();

        bytes memory data = abi.encodePacked(hex"7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d7b226e616d65223a20224a6f686e222c2022616765223a2033302c202263697479223a20224e657720596f726b227d");
        
        (uint8 v, bytes32 r, bytes32 s) = vm.sign(terraPrivateKey, keccak256(data));

        vm.startPrank(seller);
            marketplace.fulfillOrder(0, v, r, s, keccak256(data), marketplace.encryptBytes(data, publicKey, n));
        vm.stopPrank();

        vm.expectRevert("hashes are equal. invalid dispute");
            marketplace.disputeOrder(0,83,23);

        vm.warp(block.timestamp + marketplace.disputePeriod() + 1);

        vm.prank(seller);
            marketplace.completeOrder(0);
        
        require(usdc.balanceOf(address(seller)) == 100*10**18, "usdc balance not 100");


        assertEq(marketplace.getUnencryptedPurchase(0, privateKey), data);

    }
}
